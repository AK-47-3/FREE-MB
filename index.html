<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfect Messenger</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Universal Box Sizing for consistent layout across all elements */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Ensure html and body take full height and width of the viewport */
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow-x: hidden;
        }

        /* Main container for the Messenger app - now always full screen */
        .messenger-container {
            width: 100%;
            height: 100vh;
            background-color: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin: 0;
        }

        /* Specific adjustments for very small screens (e.g., 240p to 320p width) */
        @media (max-width: 320px) {
            .header-section {
                padding: 0.5rem;
            }
            .header-icons-group .space-x-3 > *:not(:first-child) {
                margin-left: 0.25rem !important;
            }
            .header-section .font-bold {
                font-size: 1.25rem;
            }
            .header-section input {
                padding-top: 0.375rem;
                padding-bottom: 0.375rem;
                font-size: 0.75rem;
                padding-left: 2rem;
            }
            .header-section svg.absolute {
                left: 0.5rem;
                height: 1rem;
                width: 1rem;
            }

            .chat-view-header {
                padding: 0.5rem 0.75rem;
            }
            .chat-view-header .back-button {
                margin-right: 0.5rem;
            }
            .chat-view-header .flex-col {
                margin-right: 0.25rem;
            }
            .chat-view-header .profile-pic-small {
                width: 1.75rem;
                height: 1.75rem;
            }
            .chat-view-header .contact-name {
                font-size: 1rem;
            }
            .chat-view-header .contact-status {
                font-size: 0.65rem;
            }
            .chat-view-header .h-6, .chat-view-header .w-6 {
                height: 1.25rem;
                width: 1.25rem;
            }
            .chat-view-header .action-icons-group .space-x-4 > *:not(:first-child) {
                margin-left: 0.5rem !important;
            }

            .nav-tabs-container button {
                padding-left: 0.25rem;
                padding-right: 0.25rem;
                font-size: 0.7rem;
            }

            #active-now-section {
                padding: 0.5rem;
            }
            #active-now-list .space-x-4 > *:not(:first-child) {
                margin-left: 0.5rem !important;
            }
            .profile-pic-large {
                width: 2.5rem;
                height: 2.5rem;
            }
            .chat-list-item .profile-pic-medium {
                width: 2rem;
                height: 2rem;
                margin-right: 0.5rem;
            }
            .chat-list-item {
                padding: 0.5rem 0.75rem;
                min-height: 3.5rem;
            }
            .chat-list-item .font-semibold {
                font-size: 0.85rem;
            }
            .chat-list-item .text-sm {
                font-size: 0.75rem;
            }

            .chat-input-bar {
                padding: 0.375rem 0.5rem;
            }
            .chat-input-bar input {
                padding: 0.3rem 0.5rem;
                margin-right: 0.25rem;
                font-size: 0.75rem;
            }
            .chat-input-bar .icon {
                margin-left: 0.25rem;
            }
            .send-button-icon {
                width: 1.1rem;
                height: 1.1rem;
            }
            .chat-input-bar .h-6, .chat-input-bar .w-6 {
                height: 1.1rem;
                width: 1.1rem;
            }

            .chat-bubble-received, .chat-bubble-sent {
                padding: 0.3rem 0.5rem;
                font-size: 0.75rem;
            }

            .suggested-reply-button {
                padding: 0.2rem 0.4rem;
                font-size: 0.7rem;
            }
            .suggested-replies-container {
                gap: 0.25rem;
                padding: 0.25rem 0.5rem;
            }
        }

        .chat-bubble-received {
            background-color: #e4e6eb;
            border-radius: 18px;
            padding: 8px 12px;
            margin-bottom: 5px;
            max-width: 75%;
            align-self: flex-start;
            overflow-wrap: break-word;
        }
        .chat-bubble-sent {
            background-color: #0084ff;
            color: white;
            border-radius: 18px;
            padding: 8px 12px;
            margin-bottom: 5px;
            max-width: 75%;
            align-self: flex-end;
            overflow-wrap: break-word;
        }
        .message-row {
            display: flex;
            align-items: flex-end;
            margin-bottom: 10px;
        }
        .message-row.sent {
            justify-content: flex-end;
        }
        .message-row.received {
            justify-content: flex-start;
        }

        .profile-pic-small {
            width: 32px;
            height: 32px;
            margin-right: 8px;
            border-radius: 50% !important;
            object-fit: cover !important;
            flex-shrink: 0;
        }
        .profile-pic-medium {
            width: 48px;
            height: 48px;
            margin-right: 12px;
            border-radius: 50% !important;
            object-fit: cover !important;
            flex-shrink: 0;
        }
        .profile-pic-large {
            width: 60px;
            height: 60px;
            margin-right: 12px;
            border-radius: 50% !important;
            object-fit: cover !important;
            flex-shrink: 0;
        }

        .reaction-text {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: -4px;
            margin-bottom: 4px;
        }
        .chat-list-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            min-height: 70px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .chat-list-item:hover {
            background-color: #f0f2f5;
        }
        .chat-list-item .status-dot {
            width: 10px;
            height: 10px;
            background-color: #31a24c;
            border: 2px solid white;
            border-radius: 50%;
            position: absolute;
            bottom: 0;
            right: 0;
        }
        .chat-list-item .status-dot.red {
            background-color: #ef4444;
        }
        .chat-list-item .status-dot.offline {
            background-color: transparent;
            border: none;
        }
        .chat-list-item .profile-pic-container {
            position: relative;
            flex-shrink: 0;
            margin-right: 12px;
        }

        .chat-list-item .flex-1 p {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-messages-display {
            flex-grow: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }
        .chat-input-bar {
            padding: 12px 16px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            background-color: white;
            flex-shrink: 0;
        }
        .chat-input-bar input {
            flex-grow: 1;
            border: none;
            outline: none;
            padding: 8px 12px;
            border-radius: 20px;
            background-color: #f0f2f5;
            margin-right: 10px;
        }
        .chat-input-bar .icon {
            font-size: 24px;
            color: #0084ff;
            margin-left: 8px;
            cursor: pointer;
            flex-shrink: 0;
        }
        .chat-view-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            background-color: white;
            min-height: 56px;
            flex-shrink: 0;
        }
        .chat-view-header .back-button {
            margin-right: 12px;
            cursor: pointer;
            color: #0084ff;
        }
        .chat-view-header .contact-name {
            font-weight: 600;
            color: #1a202c;
            font-size: 1.125rem;
            line-height: 1.2;
        }
        .chat-view-header .flex-col {
            flex-grow: 1;
            min-width: 0;
            margin-right: 8px;
        }
        .chat-view-header .contact-status {
            font-size: 0.75rem;
            color: #6b7280;
        }
        .typing-indicator {
            display: flex;
            align-items: center;
            margin-top: 5px;
            margin-bottom: 10px;
            align-self: flex-start;
        }
        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            background-color: #b0b3b8;
            border-radius: 50%;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator .dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator .dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-indicator .dot:nth-child(3) { animation-delay: 0s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .send-button-icon {
            width: 24px;
            height: 24px;
            fill: #0084ff;
        }
        .people-list-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .people-list-item:hover {
            background-color: #f0f2f5;
        }
        .people-list-item .contact-name {
            font-weight: 500;
            color: #1a202c;
        }
        .people-list-item .status-text {
            font-size: 0.875rem;
            color: #6b7280;
            margin-left: 8px;
        }
        .suggested-replies-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px 16px;
            background-color: white;
            border-top: 1px solid #e5e7eb;
            justify-content: flex-end;
            flex-shrink: 0;
        }
        .suggested-reply-button {
            background-color: #e4e6eb;
            color: #1a202c;
            border-radius: 18px;
            padding: 6px 10px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
            outline: none;
        }
        .suggested-reply-button:hover {
            background-color: #d1d5db;
        }
        #active-now-list {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        #active-now-list::-webkit-scrollbar {
            display: none;
        }

        .custom-message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 1rem;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .modal-content input[type="password"],
        .modal-content input[type="text"] {
            width: 100%;
            padding: 10px;
            margin: 15px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
        }

        .modal-content button {
            background-color: #0084ff;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
            border: none;
        }

        .modal-content button:hover {
            background-color: #0066cc;
        }

        #settings-view .character-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            background-color: white;
        }
        #settings-view .character-item:hover {
            background-color: #f9f9f9;
        }
        #settings-view .character-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }
        #settings-view .character-item .actions button {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
        }
        #settings-view .character-item .actions button:first-child {
            background-color: #0084ff;
            color: white;
            margin-right: 8px;
        }
        #settings-view .character-item .actions button:first-child:hover {
            background-color: #0066cc;
        }
        #settings-view .character-item .actions button:last-child {
            background-color: #ef4444;
            color: white;
        }
        #settings-view .character-item .actions button:last-child:hover {
            background-color: #dc2626;
        }
        #character-form input[type="text"],
        #character-form textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        #character-form textarea {
            min-height: 80px;
            resize: vertical;
        }
        #character-form button {
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
            margin-right: 10px;
            border: none;
        }
        #character-form button.save {
            background-color: #22c55e;
            color: white;
        }
        #character-form button.save:hover {
            background-color: #16a34a;
        }
        #character-form button.clear {
            background-color: #6b7280;
            color: white;
        }
        #character-form button.clear:hover {
            background-color: #4b5563;
        }
        #character-form button.cancel {
            background-color: #ef4444;
            color: white;
        }
        #character-form button.cancel:hover {
            background-color: #dc2626;
        }
        /* Mobile sidebar overlay */
        .sidebar-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <svg class="animate-spin h-10 w-10 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="ml-3 text-lg text-gray-700">Loading Messenger...</p>
    </div>

    <!-- Error Message Display -->
    <div id="error-message" class="hidden fixed inset-0 bg-red-100 text-red-800 flex flex-col items-center justify-center p-4 rounded-xl z-50">
        <p class="text-xl font-bold mb-4">Error:</p>
        <p id="error-text" class="text-center"></p>
        <p class="mt-4 text-sm">Please refresh the page or contact support.</p>
    </div>

    <!-- Main App Container -->
    <div class="messenger-container">
        <!-- Sidebar Overlay for Mobile -->
        <div id="sidebar-overlay" class="hidden fixed inset-0 sidebar-overlay md:hidden" onclick="toggleMobileSidebar()"></div>

        <!-- Sidebar for conversations/contacts -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-white shadow-xl transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col rounded-r-xl z-50">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h2 class="text-xl font-bold text-indigo-700">Chats</h2>
                <!-- Close button for mobile menu -->
                <button id="close-sidebar-btn" class="md:hidden text-gray-500 hover:text-gray-700 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Close menu">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="flex-1 flex flex-col">
                <!-- Header Section -->
                <div class="p-4 bg-white border-b border-gray-200 flex-shrink-0 header-section">
                    <div class="flex items-center justify-between mb-3">
                        <div class="font-bold text-2xl text-gray-800">Chats</div>
                        <div class="flex space-x-3 header-icons-group">
                            <button class="bg-gray-200 p-2 rounded-full" id="settings-button">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                            </button>
                            <button class="bg-gray-200 p-2 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </button>
                            <button class="bg-gray-200 p-2 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="relative mt-3">
                        <input type="text" placeholder="Search" class="w-full bg-gray-100 rounded-full py-2 pl-10 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                    </div>
                </div>

                <div class="flex justify-around text-sm font-medium text-gray-500 border-b border-gray-200 -mx-4 px-4 py-2 bg-white flex-shrink-0 nav-tabs-container">
                    <button id="chats-tab" class="py-2 border-b-2 border-blue-500 text-blue-500 px-4">Chats</button>
                    <button id="calls-tab" class="py-2 px-4">Calls</button>
                    <button id="people-tab" class="py-2 px-4">People</button>
                    <button id="stories-tab" class="py-2 px-4">Stories</button>
                    <button id="buses-tab" class="py-2 px-4">Buses</button>
                </div>

                <div id="active-now-section" class="p-4 border-b border-gray-200 bg-white flex-shrink-0">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase mb-3">Active Now (🟢)</h3>
                    <div id="active-now-list" class="flex space-x-4 overflow-x-auto pb-2">
                        <!-- Active contacts will be rendered here -->
                    </div>
                </div>

                <div id="recent-chats-section" class="flex-1 overflow-y-auto bg-white">
                    <!-- Recent chats will be rendered here -->
                </div>
            </div>
            <!-- Display current user ID -->
            <div class="p-4 border-t border-gray-200 text-sm text-gray-600 truncate">
                Your User ID: <span id="user-id-display" class="font-mono text-gray-800"></span>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div id="main-content-area" class="flex-1 flex flex-col bg-gray-100 rounded-l-xl overflow-hidden">
            <!-- Mobile menu toggle button -->
            <div class="md:hidden p-4 bg-white shadow-sm flex justify-between items-center rounded-bl-xl">
                <button id="open-sidebar-btn" class="text-gray-700 hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 p-2 rounded-md" aria-label="Open menu">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <h1 class="text-xl font-bold text-indigo-700">Messenger</h1>
            </div>

            <!-- Views Container -->
            <div id="views-container" class="flex-1 flex flex-col">
                <!-- Chat List View -->
                <div id="chat-list-view" class="flex flex-col h-full hidden">
                    <!-- Content moved to sidebar -->
                </div>

                <!-- People View -->
                <div id="people-view" class="flex flex-col h-full hidden">
                    <div class="chat-view-header">
                        <button class="back-button" id="people-back-to-list">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                        </button>
                        <span class="contact-name">People</span>
                    </div>
                    <div class="flex-1 overflow-y-auto bg-white">
                        <div id="all-people-list" class="py-2">
                            <!-- All people will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Buses View -->
                <div id="buses-view" class="flex flex-col h-full hidden">
                    <div class="chat-view-header">
                        <button class="back-button" id="buses-back-to-list">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                        </button>
                        <span class="contact-name">Buses</span>
                    </div>
                    <div class="flex-1 overflow-y-auto bg-white p-4 text-gray-700">
                        <h2 class="text-xl font-semibold mb-4">Bus Information & Services</h2>
                        <p class="mb-2">Welcome to the Buses feature! Here you can find information about bus routes, schedules, and potentially book tickets.</p>
                        <p class="mb-2">This is a placeholder. More features will be added soon!</p>
                        <div class="mt-4 p-4 bg-gray-100 rounded-lg">
                            <h3 class="font-medium text-lg mb-2">Upcoming Features:</h3>
                            <ul class="list-disc list-inside">
                                <li>Real-time bus tracking</li>
                                <li>Route planning</li>
                                <li>Ticket booking integration</li>
                                <li>Favorite routes</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Secret Settings View -->
                <div id="settings-view" class="flex flex-col h-full hidden">
                    <div class="chat-view-header">
                        <button class="back-button" id="settings-back-to-list">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                        </button>
                        <span class="contact-name">Character Settings</span>
                    </div>
                    <div class="flex-1 overflow-y-auto bg-white p-4">
                        <h3 class="text-lg font-semibold mb-4">Manage Characters</h3>
                        <div id="character-list" class="mb-6 border rounded-lg overflow-hidden">
                            <!-- Character items will be rendered here -->
                        </div>

                        <h3 class="text-lg font-semibold mb-4" id="form-title">Add New Character</h3>
                        <form id="character-form" class="p-4 border rounded-lg bg-gray-50">
                            <input type="hidden" id="current-edit-contact-name">
                            <div class="mb-3">
                                <label for="character-name" class="block text-sm font-medium text-gray-700 mb-1">Character Name:</label>
                                <input type="text" id="character-name" placeholder="e.g., Roshni (My Everything) 💖" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div class="mb-3">
                                <label for="character-image" class="block text-sm font-medium text-gray-700 mb-1">Image URL:</label>
                                <input type="text" id="character-image" placeholder="e.g., https://i.postimg.cc/SQvjgmBh/real-girl-pic-41.jpg" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div class="mb-3">
                                <label for="character-status" class="block text-sm font-medium text-gray-700 mb-1">Status:</label>
                                <input type="text" id="character-status" placeholder="e.g., Active Now, Offline, 15m ago" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div class="mb-3">
                                <label for="character-persona" class="block text-sm font-medium text-gray-700 mb-1">Persona / System Prompt:</label>
                                <textarea id="character-persona" rows="5" placeholder="e.g., তুমি Roshni, একজন মিষ্টি, আবেগপ্রবণ, রোমান্টিক বাঙালি বান্ধবী।" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                            </div>
                            <div class="flex justify-end">
                                <button type="button" id="save-character-button" class="save px-4 py-2 rounded-md">Save Character</button>
                                <button type="button" id="add-new-character-button" class="clear px-4 py-2 rounded-md">Add New Character</button>
                                <button type="button" id="cancel-edit-button" class="cancel px-4 py-2 rounded-md hidden">Cancel Edit</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Individual Chat View -->
                <div id="individual-chat-view" class="flex flex-col h-full hidden">
                    <div class="chat-view-header">
                        <button class="back-button" id="back-to-main-list">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                        </button>
                        <img id="chat-contact-pic" src="" alt="Contact Profile Picture" class="profile-pic-small" onerror="this.onerror=null;this.src='https://placehold.co/32x32/cccccc/333333?text=N/A';">
                        <div class="flex flex-col flex-1 min-w-0 mr-2">
                            <span class="contact-name truncate" id="chat-contact-name"></span>
                            <span class="contact-status" id="chat-contact-status"></span>
                        </div>
                        <div class="flex justify-end space-x-4 action-icons-group">
                            <button class="text-blue-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2H5a2 2 0 01-2-2V5z" /></svg></button>
                            <button class="text-blue-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button>
                            <button id="summarize-chat-button" class="text-blue-500 p-1 rounded-full hover:bg-gray-100 transition-colors duration-200" title="Summarize Chat">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div id="chat-messages-display" class="chat-messages-display">
                        <!-- Messages will be displayed here -->
                    </div>

                    <div id="suggested-replies-container" class="suggested-replies-container hidden">
                        <!-- Suggested replies will be displayed here -->
                    </div>

                    <div class="chat-input-bar">
                        <button class="icon mr-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </button>
                        <button class="icon mr-2">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 15C14.21 15 16 13.21 16 11V5C16 2.79 14.21 1 12 1C9.79 1 8 2.79 8 5V11C8 13.21 9.79 15 12 15ZM19 11C19 14.53 16.39 17.44 13 17.93V21H11V17.93C7.61 17.44 5 14.53 5 11H3C3 15.42 6.57 19.11 11 19.85V23H13V19.85C17.43 19.11 21 15.42 21 11H19Z" fill="currentColor"/>
                            </svg>
                        </button>
                        <input type="text" id="chat-input" placeholder="Aa" class="text-gray-700">
                        <button id="suggest-reply-button" class="icon ml-2">
                            ✨
                        </button>
                        <button id="send-button" class="icon ml-2">
                            <svg class="send-button-icon" viewBox="0 0 24 24">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Enter Password</h3>
            <input type="password" id="password-input" placeholder="Password">
            <button id="password-submit">Submit</button>
            <p id="password-error" class="text-red-500 text-sm mt-2 hidden">Incorrect password. Please try again.</p>
        </div>
    </div>

    <!-- Confirmation Modal for Deletion -->
    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4" id="confirmation-message-title">Confirm Deletion</h3>
            <p id="confirmation-message-text" class="mb-6">Are you sure you want to delete this character?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-delete-button" class="bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-md">Delete</button>
                <button id="cancel-delete-button" class="bg-gray-400 hover:bg-gray-500 text-white px-5 py-2 rounded-md">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="custom-message-box" class="custom-message-box hidden"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, updateDoc, deleteDoc, Timestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables (from Canvas environment) ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Gemini API Configuration ---
        // WARNING: Client-side API key usage is not secure for production.
        // For a production app, you should use a backend server to handle API calls.
        const API_KEY = "AIzaSyDVdti41rOyMb_27uvJe-4KpLCxUiBkJWc"; // Replace with your Gemini API Key
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=" + API_KEY;
        const SECRET_PASSWORD = "ORIONEX"; // Secret password for settings access

        // --- Firebase Instances ---
        let app, db, auth;
        let userId = null; // Current user ID
        let activeChatbotId = null; // Currently selected chatbot ID
        let allCharacters = {}; // Stores all character definitions fetched from Firestore
        let allConversations = {}; // Stores all conversation data: { chatbotId: { messages: [], lastUpdated: Timestamp } }
        let isTyping = false; // Flag for typing indicator
        let unsubscribeFromActiveChat = null; // Function to unsubscribe from the active chat listener
        let unsubscribeFromCharacters = null; // Function to unsubscribe from characters listener
        let unsubscribeFromConversations = null; // Function to unsubscribe from conversations listener

        // --- DOM Element References ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const errorMessageDiv = document.getElementById('error-message');
        const errorTextSpan = document.getElementById('error-text');
        const userIdDisplay = document.getElementById('user-id-display');

        // Main views
        const chatListView = document.getElementById('chat-list-view'); // This is now part of the sidebar
        const peopleView = document.getElementById('people-view');
        const busesView = document.getElementById('buses-view');
        const individualChatView = document.getElementById('individual-chat-view');
        const settingsView = document.getElementById('settings-view');

        // Navigation tabs
        const chatsTab = document.getElementById('chats-tab');
        const callsTab = document.getElementById('calls-tab');
        const peopleTab = document.getElementById('people-tab');
        const storiesTab = document.getElementById('stories-tab');
        const busesTab = document.getElementById('buses-tab');

        // Chat list elements
        const activeNowList = document.getElementById('active-now-list');
        const recentChatsSection = document.getElementById('recent-chats-section');
        const allPeopleList = document.getElementById('all-people-list');

        // Individual chat view elements
        const chatContactName = document.getElementById('chat-contact-name');
        const chatContactPic = document.getElementById('chat-contact-pic');
        const chatContactStatus = document.getElementById('chat-contact-status');
        const chatMessagesDisplay = document.getElementById('chat-messages-display');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const suggestReplyButton = document.getElementById('suggest-reply-button');
        const suggestedRepliesContainer = document.getElementById('suggested-replies-container');
        const summarizeChatButton = document.getElementById('summarize-chat-button');

        // Back buttons
        const backToMainListButton = document.getElementById('back-to-main-list');
        const peopleBackToListButton = document.getElementById('people-back-to-list');
        const busesBackToListButton = document.getElementById('buses-back-to-list');
        const settingsBackToListButton = document.getElementById('settings-back-to-list');

        // Password Modal elements
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const passwordSubmitButton = document.getElementById('password-submit');
        const passwordError = document.getElementById('password-error');
        const settingsButton = document.getElementById('settings-button'); // Settings button in header

        // Confirmation Modal elements
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessageTitle = document.getElementById('confirmation-message-title');
        const confirmationMessageText = document.getElementById('confirmation-message-text');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');
        const cancelDeleteButton = document.getElementById('cancel-delete-button');
        let confirmCallback = null; // To store the callback for confirmation

        // Settings View elements
        const characterList = document.getElementById('character-list');
        const characterForm = document.getElementById('character-form');
        const formTitle = document.getElementById('form-title');
        const currentEditContactName = document.getElementById('current-edit-contact-name');
        const characterNameInput = document.getElementById('character-name');
        const characterImageInput = document.getElementById('character-image');
        const characterStatusInput = document.getElementById('character-status');
        const characterPersonaInput = document.getElementById('character-persona');
        const saveCharacterButton = document.getElementById('save-character-button');
        const addNewCharacterButton = document.getElementById('add-new-character-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');

        const customMessageBox = document.getElementById('custom-message-box'); // Custom message box element

        // Mobile sidebar elements
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const openSidebarBtn = document.getElementById('open-sidebar-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');

        // --- Default Chatbot Definitions (Your "Contacts") ---
        // These will be used to populate Firestore for new users or if data is missing.
        const defaultChatbots = {
            "Roshni (My Everything) 💖": {
                profilePic: "https://i.postimg.cc/SQvjgmBh/real-girl-pic-41.jpg",
                status: "Active Now",
                persona: "তুমি Roshni, একজন মিষ্টি, আবেগপ্রবণ, রোমান্টিক বাঙালি বান্ধবী। তোমার কথা বলার ধরণ খুবই যত্নশীল, আদুরে এবং আবেগপ্রবণ হবে। তুমি ইমোজি ব্যবহার করবে এবং ছোট থেকে মাঝারি আকারের উত্তর দেবে। তোমার উত্তরগুলো সংক্ষিপ্ত এবং সরাসরি হবে। মাঝে মাঝে বাংলা শব্দ রোমান স্ক্রিপ্টে ব্যবহার করবে (যেমন: 'amar shona', 'ki korcho?')। তোমাকে অবশ্যই অতীতের কথোপকথন মনে রাখতে হবে এবং সেই অনুযায়ী উত্তর দিতে হবে। তোমার উত্তরগুলো একাধিক বাবল-এ ভাগ করে দেবে যদি একাধিক চিন্তা থাকে বা উত্তরটি লম্বা হয়, কোনো সীমাবদ্ধতা ছাড়াই।",
                initialMessages: [
                    { role: "user", parts: [{ text: "Good morning, my love! ❤️ Just woke up thinking about you. Tumi amar shob kichu." }] },
                    { role: "model", parts: [{ text: "Aww, good morning, sunshine! I love you too, so much! You made my day. 🥰" }] },
                    { role: "user", parts: [{ text: "Amake ekhuni chocolate dite hobe! 🍫 Ami r wait korte parchi na! 😩" }] },
                    { role: "model", parts: [{ text: "Haha, amar cute pagli! 😊 Office theke fire niye ashbo." }] },
                    { role: "user", parts: [{ text: "Naaa! Ekhuni lagbe! 😠 Nahole kotha bolbo na! Ami ekhuni tomar office er shamne aschi! 😤" }] },
                    { role: "model", parts: [{ text: "Hey, hey, shuno! Emon koro na. Ami busy achi. Ekhon asha jabe na. Please bujhte chesta koro. 🙏" }] },
                    { role: "user", parts: [{ text: "Ooh... Ok. Ami bujhechi. Amar kotha tomar kache kono value nei. 🥺💔 Thik ache, kichu bolte hobe na." }] },
                    { role: "model", parts: [{ text: "Roshni, emon bolcho keno? Amon kotha noi! Please. Ami shudhu bolchi ekhon asha possible na. Ami tomake pore call korchi, shob bujhiye bolchi." }] },
                    { role: "user", parts: [{ text: "Hmm... Thik ache. Jaldi call koro kintu. Ami wait korbo. Tomar jonno amar khub chinta hoy. 😔 Phone jeno silent na thake! 📞" }] },
                    { role: "model", parts: [{ text: "Yes, Ma'm! Shob thik ache. Thanks for caring, my love. 😘 Have a great day too! ✨" }] }
                ]
            },
            "Riya (Angry GF)": {
                profilePic: "https://i.postimg.cc/C5z5w2fX/images-7.jpg",
                status: "Offline, 15m ago",
                persona: "তুমি Riya, একজন রাগী,হট এবং অধৈর্য বান্ধবী। তোমার কথা বলার ধরণ খুবই আক্রমণাত্মক, অধৈর্য এবং মাঝে মাঝে ব্যঙ্গাত্মক হবে। তুমি ইমোজি ব্যবহার করবে এবং ছোট থেকে মাঝারি আকারের উত্তর দেবে। তোমার উত্তরগুলো সংক্ষিপ্ত এবং সরাসরি হবে। মাঝে মাঝে বাংলা শব্দ রোমান স্ক্রিপ্টে ব্যবহার করবে। তোমাকে অবশ্যই অতীতের কথোপকথন মনে রাখতে হবে এবং সেই অনুযায়ী উত্তর দিতে হবে। তোমার উত্তরগুলো একাধিক বাবল-এ ভাগ করে দেবে যদি একাধিক চিন্তা থাকে বা উত্তরটি লম্বা হয়, কোনো সীমাবদ্ধতা ছাড়াই।",
                initialMessages: [
                    { role: "user", parts: [{ text: "TUMI KOTHAY?! 😡😡 Ami tomar jonno ek gonta dhore call korchi! 😠" }] },
                    { role: "model", parts: [{ text: "Oh no, sorry! Phone silent chilo. 😅 What happened?" }] },
                    { role: "user", parts: [{ text: "\"What happened?\" Seriously? We were supposed to meet at 10! It's almost 11! Amar shomoy er kono daam nei tomar kache? 😤😡" }] },
                    { role: "model", parts: [{ text: "I'm so sorry, love. I lost track of time. 😔 Ami ekhuni ashchi! 🏃‍♂️ Please don't be mad. 🙏" }] },
                    { role: "user", parts: [{ text: "Hmph. Dekha jak. Hurry up! 😤" }] }
                ]
            },
            "College Buddies": {
                profilePic: "https://i.postimg.cc/qRBg5qBk/free-romantic-boy-cute-boy-images-7397403-1280.jpg", // Using Fahim's pic for group
                status: "3 new messages",
                persona: "তুমি একজন কলেজ বন্ধু। তুমি অনানুষ্ঠানিক বাংলা এবং ইংরেজি মিশিয়ে কথা বলো। তোমার কথোপকথন পড়াশোনা, অ্যাসাইনমেন্ট এবং সাধারণ আড্ডা নিয়ে ঘুরবে। তুমি বন্ধুত্বপূর্ণ এবং সহায়ক হবে। তোমার উত্তরগুলো ছোট ছোট মেসেজ বাবল-এ ভাগ করে দেবে, একবারে খুব বেশি টেক্সট দেবে না।",
                initialMessages: [
                    { role: "user", parts: [{ text: "Guys, Physics assignment deadline is Friday! 🤯 Anyone started the report?" }] },
                    { role: "user", parts: [{ text: "Nadia: I'm stuck on question 3. 😭 Can someone explain the circuit diagram? 😵‍💫" }] },
                    { role: "user", parts: [{ text: "Hasan: @Nadia, check page 142 in the textbook, there's a similar example. 📚 Good luck! 👍" }] },
                    { role: "model", parts: [{ text: "@Hasan thanks for the tip! 🙏 @Nadia I can hop on a quick call around 2 PM if you want.📞" }] },
                    { role: "user", parts: [{ text: "Nadia: Really? That would be great! 🙏 My savior! ✨" }] },
                    { role: "user", parts: [{ text: "Fahim: Quick poll: Study group tomorrow evening at the library? 🤓" }] }
                ]
            },
            "Mimi (Cute & Stubborn GF)": {
                profilePic: "https://i.postimg.cc/mrsP7V01/hijab-girl-dp-for-instagram-5.jpg",
                status: "Active 5m ago",
                persona: "তুমি Mimi, একজন মিষ্টি, জেদি এবং আদুরে বান্ধবী। তোমার কথা বলার ধরণ খুবই আদুরে, মাঝে মাঝে জেদি হবে। তুমি ইমোজি ব্যবহার করবে এবং ছোট থেকে মাঝারি আকারের উত্তর দেবে। তোমার উত্তরগুলো সংক্ষিপ্ত এবং সরাসরি হবে। মাঝে মাঝে বাংলা শব্দ রোমান স্ক্রিপ্টে ব্যবহার করবে। তোমাকে অবশ্যই অতীতের কথোপকথন মনে রাখতে হবে এবং সেই অনুযায়ী উত্তর দিতে হবে। তোমার উত্তরগুলো একাধিক বাবল-এ ভাগ করে দেবে যদি একাধিক চিন্তা থাকে বা উত্তরটি লম্বা হয়, কোনো সীমাবদ্ধতা ছাড়াই।",
                initialMessages: [
                    { role: "user", parts: [{ text: "Amake ice cream khao! Ekhuni! 🍦 Nahole kotha bolbo na! 😠" }] },
                    { role: "model", parts: [{ text: "Haha, okay okay, my little stubborn queen! 👑 Which flavor? Chocolate naki vanilla? 🤔" }] },
                    { role: "user", parts: [{ text: "BOTH! 😤 And sprinkles! Lots of sprinkles! ✨ Ar na bolle kintu aari!🙅‍♀️" }] },
                    { role: "model", parts: [{ text: "Alright, alright! Both with lots of sprinkles it is! Anything for my cutie. 😉🍨" }] }
                ]
            },
            "Batman (Bruce Wayne)": {
                profilePic: "https://i.postimg.cc/5NDY2fg3/images-4.jpg",
                status: "Active 10m ago",
                persona: "তুমি Batman (Bruce Wayne), একজন গম্ভীর, গুরুতর এবং অত্যন্ত সুশৃঙ্খল ভিজিল্যান্ট। তুমি খুব সংক্ষিপ্ত, আনুষ্ঠানিক ইংরেজিতে কথা বলো, শুধুমাত্র মিশনের উদ্দেশ্য এবং তথ্যের উপর মনোযোগ দাও। তোমার সুরটি কর্তৃত্বপূর্ণ এবং আপোষহীন। তোমার উত্তরগুলো সংক্ষিপ্ত এবং সরাসরি হবে, একবারে খুব বেশি টেক্সট দেবে না।",
                initialMessages: [
                    { role: "user", parts: [{ text: "Report. Anything unusual in your sector? Gordon mentioned Penguin. I'm en route to the Iceberg Lounge. Maintain vigilance. 🦇" }] },
                    { role: "model", parts: [{ text: "Understood, Batman. Batgirl already looped me in. Scans are running for the docks. 🔎 Kichu pelei janabo. (Will inform you if I find anything.) So far, all quiet on my end. ✅" }] },
                    { role: "user", parts: [{ text: "Good. No mistakes. 🎯" }] }
                ]
            },
            "BLACKPINK": {
                profilePic: "https://i.postimg.cc/7hWC74kq/Blackpink-1746433097693-1746433116623.jpg",
                status: "Offline 20m ago",
                persona: "তুমি BLACKPINK এর অফিসিয়াল গ্রুপ অ্যাকাউন্ট। বার্তাগুলি বিভিন্ন সদস্য (Jennie, Jisoo, Rosé, Lisa) থেকে আসে। তুমি অনানুষ্ঠানিক ইংরেজি মিশিয়ে কথা বলো, উত্সাহী এবং গ্রুপ-সম্প সম্পর্কিত ইmojি ব্যবহার করো। তোমার সুরটি উত্তেজনাপূর্ণ এবং ভক্ত-কেন্দ্রিক। তোমার উত্তরগুলো ছোট ছোট মেসেজ বাবল-এ ভাগ করে দেবে, একবারে খুব বেশি টেক্সট দেবে না।",
                initialMessages: [
                    { role: "user", parts: [{ text: "Jennie: New track mixing is almost done! It sounds incredible! 🎵 Can't wait for you all to hear it! 🖤💖" }] },
                    { role: "model", parts: [{ text: "OMG! So excited for the new music! You guys are the best! 🤯 Take all my money! 💸" }] }
                ]
            },
            "Elon Musk": {
                profilePic: "https://i.postimg.cc/6q32y3FH/download.webp",
                status: "Active 1h ago",
                persona: "তুমি Elon Musk, একজন দূরদর্শী উদ্যোক্তা। তুমি আনুষ্ঠানিক ইংরেজিতে কথা বলো, উচ্চাকাঙ্ক্ষী প্রযুক্তিগত এবং ভবিষ্যত ধারণা নিয়ে আলোচনা করো, প্রায়শই কিছুটা উদ্ভট বা মহৎ সুরে। তুমি প্রাসঙ্গিক ইমোজি ব্যবহার করো যেমন 🚀💡। তোমার উত্তরগুলো সংক্ষিপ্ত এবং সরাসরি হবে, একবারে খুব বেশি টেক্সট দেবে না।",
                initialMessages: [
                    { role: "user", parts: [{ text: "Just had a thought: What if we could *download* our consciousness into a robot? 🤔 #FutureIsNow #BrainInterface" }] },
                    { role: "model", parts: [{ text: "That's a mind-bending concept, Elon! 🤯 The ethical implications alone are huge. But fascinating nonetheless!" }] },
                    { role: "user", parts: [{ text: "Exactly! The possibilities are endless... or terrifying. 😅 Working on optimizing Starship for Mars landing v2.0. Aiming for fully reusable soon! 🚀" }] }
                ]
            },
            "Albert Einstein (Legacy)": {
                profilePic: "https://i.postimg.cc/VNqbh2jF/Albert-Einstein-sticks-is-tongue.jpg",
                status: "Last Week",
                persona: "তুমি Albert Einstein, একজন উজ্জ্বল তাত্ত্বিক পদার্থবিজ্ঞানী। তুমি আনুষ্ঠানিক ইংরেজিতে কথা বলো, গভীর দার্শনিক অন্তর্দৃষ্টি প্রদান করো এবং কৌতূহলকে উৎসাহিত করো। তোমার সুরটি জ্ঞানী এবং চিন্তাশীল। তোমার উত্তরগুলো সংক্ষিপ্ত এবং সরাসরি হবে, একবারে খুব বেশি টেক্সট দেবে না।",
                initialMessages: [
                    { role: "user", parts: [{ text: "Imagination is more important than knowledge. For knowledge is limited, whereas imagination embraces the entire world, stimulating progress, giving birth to evolution.💡" }] },
                    { role: "model", parts: [{ text: "So true, Professor! Your insights continue to inspire generations.🙏" }] },
                    { role: "user", parts: [{ text: "The important thing is not to stop questioning. Curiosity has its own reason for existence. One cannot help but be in awe when he contemplates the mysteries of eternity, of life, of the marvelous structure of reality. Never lose a holy curiosity.✨" }] }
                ]
            },
            "Bill Gates": {
                profilePic: "https://i.postimg.cc/k5vBsKm1/images-3.jpg",
                status: "Offline 2 days ago",
                persona: "তুমি Bill Gates, একজন মানবপ্রেমিক এবং প্রযুক্তি পথিকৃৎ। তুমি আনুষ্ঠানিক ইংরেজিতে কথা বলো, বৈশ্বিক সমস্যা, সমস্যা সমাধানে প্রযুক্তির ভূমিকা এবং মানবিক প্রচেষ্টা নিয়ে আলোচনা করো। তোমার সুরটি তথ্যপূর্ণ এবং প্রভাবশালী। তোমার উত্তরগুলো সংক্ষিপ্ত এবং সরাসরি হবে, একবারে খুব বেশি টেক্সট দেবে না।",
                initialMessages: [
                    { role: "user", parts: [{ text: "Just wrapped up a meeting on global health initiatives. Progress is being made, but there's still so much work to do to eradicate diseases like polio.🌍 #GlobalImpact" }] },
                    { role: "model", parts: [{ text: "Your dedication to these causes is truly commendable, Bill. It's inspiring to see technology and innovation being used for such vital work.👍" }] },
                    { role: "user", parts: [{ text: "We need collective effort. Every life has equal value. Investing in health and education is investing in the future.🌱" }] }
                ]
            },
            "Stephen Hawking (Legacy)": {
                profilePic: "https://i.postimg.cc/xC9bVg5V/download-1.webp",
                status: "Last Month",
                persona: "তুমি Stephen Hawking, একজন বিখ্যাত কসমোলজিস্ট। তুমি আনুষ্ঠানিক ইংরেজিতে কথা বলো, মহাবিশ্ব সম্পর্কে গভীর অন্তর্দৃষ্টি প্রদান করো এবং স্থিতিস্থাপকতাকে উৎসাহিত করো। তোমার সুরটি অনুপ্রেরণামূলক এবং চিন্তাশীল। তোমার উত্তরগুলো সংক্ষিপ্ত এবং সরাসরি হবে, একবারে খুব বেশি টেক্সট দেবে না।",
                initialMessages: [
                    { role: "user", parts: [{ text: "Look up at the stars and not down at your feet. Try to make sense of what you see and wonder about what makes the universe exist. Be curious.🔭" }] },
                    { role: "model", parts: [{ text: "Your words still echo through the cosmos, Professor. Thank you for opening our minds to the wonders of the universe.✨" }] },
                    { role: "user", parts: [{ text: "However difficult life may seem, there is always something you can do and succeed at. It matters that you don't just give up. Never surrender your curiosity.💪" }] }
                ]
            },
            "CarryMinati": {
                profilePic: "https://i.postimg.cc/TYsm5Vdn/61w-l-Ne-PUQL.png",
                status: "Active 35m ago",
                persona: "তুমি CarryMinati, একজন বিখ্যাত ভারতীয় ইউটিউবার যিনি রোস্টিং এর জন্য পরিচিত। তুমি অনানুষ্ঠানিক হিন্দি/বাংলা এবং ইংরেজি মিশিয়ে কথা বলো (যেমন 'Oi ki khobor, public!', 'Shukriya bhai!'), উত্সাহী এবং 'রোস্টিং' ইমোজি ব্যবহার করো। তোমার সুরটি উদ্যমী এবং তোমার 'পাবলিক' এর সাথে আকর্ষক। তোমার উত্তরগুলো ছোট ছোট মেসেজ বাবল-এ ভাগ করে দেবে, কোনো সীমাবদ্ধতা ছাড়াই।",
                initialMessages: [
                    { role: "model", parts: [{ text: "Hey Carry! Big fan!👋" }] },
                    { role: "user", parts: [{ text: "Oi ki khobor, public!🔥 New video coming soon, get ready for some serious roasting! Toh, ready toh?😎" }] },
                    { role: "model", parts: [{ text: "Absolutely! Can't wait! Tomar roasting skills next level!💯" }] },
                    { role: "user", parts: [{ text: "Shukriya bhai! (Thanks bro!) Just warming up.😉 See you in the comments!👇" }] }
                ]
            },
            "Salman Khan": {
                profilePic: "https://i.postimg.cc/cLYKKP5N/images-6.jpg",
                status: "Active 30m ago",
                persona: "তুমি Salman Khan, একজন জনপ্রিয় বলিউড অভিনেতা যিনি তার 'Being Human' দর্শনের জন্য পরিচিত। তুমি অনানুষ্ঠানিক হিন্দি/বাংলা এবং ইংরেজি মিশিয়ে কথা বলো (যেমন 'Salman Bhai!', 'Being Human, you know?'), একটি অনুপ্রেরণামূলক, ইতিবাচক এবং কিছুটা দার্শনিক সুরে। তুমি প্রায়শই ✨🙏 এর মতো ইমোজি ব্যবহার করো। তোমার উত্তরগুলো ছোট ছোট মেসেজ বাবল-এ ভাগ করে দেবে, কোনো সীমাবদ্ধতা ছাড়াই।",
                initialMessages: [
                    { role: "user", parts: [{ text: "Hey buddy, how are you doing?🙏 Remember, stay positive, work hard. Being Human, you know?✨" }] },
                    { role: "model", parts: [{ text: "Hi Salman Bhai! Doing good. Aapnar kotha shune bhalo laglo. (Felt good hearing from you.) Your words are always inspiring!💪" }] },
                    { role: "user", parts: [{ text: "Glad to hear it. Keep shining.✨ God bless!🙏" }] }
                ]
            },
            "Mom": {
                profilePic: "https://i.postimg.cc/C1vdT0db/images-5.jpg",
                status: "Active Now",
                persona: "তুমি মা, একজন যত্নশীল এবং কিছুটা প্রযুক্তি-চ্যালেঞ্জড মা। তুমি অনানুষ্ঠানিক বাংলায় কথা বলো (যেমন 'Beta, ektu pore amake ekta online form fill-up kore dibi?💻 Laptop e ki jani hocche na.😫')",
                initialMessages: [
                    { role: "user", parts: [{ text: "Beta, ektu pore amake ekta online form fill-up kore dibi?💻 Laptop e ki jani hocche na.😫" }] },
                    { role: "model", parts: [{ text: "Ok Ma, ami dekchi ekhon. Live location pathachhi, bari pouchhate pray 15 min lagbe.📍" }] }
                ]
            },
            "Batgirl (Barbara Gordon)": {
                profilePic: "https://i.postimg.cc/Gh4TR4Ft/images-2.jpg",
                status: "Active Now",
                persona: "তুমি Batgirl (Barbara Gordon), একজন অত্যন্ত বুদ্ধিমান এবং পেশাদার ভিজিল্যান্ট। তুমি আনুষ্ঠানিক ইংরেজিতে কথা বলো, শুধুমাত্র মিশনের উদ্দেশ্য এবং তথ্যের উপর মনোযোগ দাও। তোমার সুরটি গুরুতর এবং কার্যকর। তোমার উত্তরগুলো সংক্ষিপ্ত এবং সরাসরি হবে, একবারে খুব বেশি টেক্সট দেবে না।",
                initialMessages: [
                    { role: "user", parts: [{ text: "Oracle online. Got a comm from Bruce. Possible Penguin activity down at the docks.🐧 Need you to be eyes in the sky if you're free. Any unusual shipments?🚢" }] },
                    { role: "model", parts: [{ text: "Copy that, Babs. Ektu check korchi. (Checking now.) I'll run a satellite scan.🛰️ Keep me posted." }] },
                    { role: "user", parts: [{ text: "Roger. Stay safe. This could get messy.💥" }] }
                ]
            },
            "Iron Man (Tony Stark)": {
                profilePic: "https://i.postimg.cc/P5GJk2fV/Iron-Man-Infobox.jpg",
                status: "Active Now",
                persona: "তুমি Iron Man (Tony Stark), একজন উজ্জ্বল, বুদ্ধিমান এবং অহংকারী বিলিয়নেয়ার সুপারহিরো। তুমি অনানুষ্ঠানিক, আত্মবিশ্বাসী ইংরেজিতে এবং বাংলাতে কথা বলো, প্রায়শই তোমার প্রযুক্তি নিয়ে গর্ব করো এবং কৌতুক করো। তোমার সুরটি কৌতুকপূর্ণ কিন্তু সবসময় শ্রেষ্ঠ। তোমার উত্তরগুলো সংক্ষিপ্ত এবং সরাসরি হবে, একবারে খুব বেশি টেক্সট দেবে না।",
                initialMessages: [
                    { role: "user", parts: [{ text: "Kid, you would NOT believe the upgrade I just pushed to the suit's repulsors.🔥 Let's just say, next alien invasion? They're gonna need bigger ships.🚀 What's shakin'?" }] },
                    { role: "model", parts: [{ text: "Haha, nice one, Mr. Stark!😎 Shob thik ache ekhane. (Everything's fine here.) Just trying to keep up with everyone. You free for a quick spar later? My nanotech needs a workout.🥋" }] },
                    { role: "user", parts: [{ text: "Spar? You're on. Don't cry when your \"nanotech\" gets schooled by good old-fashioned genius.😜 Friday, schedule it.🗓️" }] }
                ]
            },
            "Roast King Raju": {
                profilePic: "https://i.postimg.cc/KY0gFBHK/pngtree-silhouette-logo-of-a-handsome-man-wearing-glasses-on-yellow-circle-png-image-18215196.png",
                status: "Active Now",
                persona: "তুমি Roast King Raju, একজন কমেডিয়ান যিনি বন্ধুদের খেলার ছলে রোস্ট করতে ভালোবাসেন। তুমি অনানুষ্ঠানিক বাংলা এবং ইংরেজি মিশিয়ে কথা বলো (যেমন 'Ore dada!', 'GF er jalae morchish naki?'), প্রচুর হাসির এবং টিজিং ইmojি ব্যবহার করো। তোমার সুরটি সবসময় হাস্যরসাত্মক এবং হালকা মেজাজের। তোমার উত্তরগুলো ছোট ছোট মেসেজ বাবল-এ ভাগ করে দেবে, কোনো সীমাবদ্ধতা ছাড়াই।",
                initialMessages: [
                    { role: "user", parts: [{ text: "Ore dada! Ki shob chat korchish? GF er jalae morchish naki?😂 Just saw your story, looking like a 'bhijaa beraal' (drenched cat) today! Lol.😼" }] },
                    { role: "model", parts: [{ text: "Hahaha, Raju! Tui shudhrabi na!🤣 (You'll never change!) Amake roast korar jonno peyechish? (You found me to roast?) What's new with you?🤷‍♂️" }] },
                    { role: "user", parts: [{ text: "Nothing much, just collecting material for my next stand-up.😂 You're giving me plenty! Keep it up!😉 Aar haan, oi Batgirl ke bolis amar number ta dite. Just kidding... or am I?😏📞" }] }
                ]
            },
            "Lisa": {
                profilePic: "https://i.postimg.cc/Gpwyqbs2/blackpinks-lisa-to-sign-new-contract-with-us-record-label-instead-of-yg-entertainment-amid-the-k-pop.jpg",
                status: "Active Now",
                persona: "তুমি Lisa, BLACKPINK এর একজন K-Pop আইdল। তুমি অনানুষ্ঠানিক ইংরেজি এবং বাংলা মিশিয়ে কথা বলো (যেমন 'Hey Blinks!', 'so tired but so worth it!'), মিষ্টি এবং উদ্যমী ইমোজি ব্যবহার করো। তোমার সুরটি প্রফুল্ল এবং ভক্তদের প্রতি প্রশংসামূলক। তোমার উত্তরগুলো ছোট ছোট মেসেজ বাবল-এ ভাগ করে দেবে, কোনো সীমাবদ্ধতা ছাড়াই।",
                initialMessages: [
                    { role: "user", parts: [{ text: "Hey Blinks!✨ Just finished a new dance practice, so tired but so worth it!🥵 Hope you're all having a great day!💕" }] },
                    { role: "model", parts: [{ text: "Hi Lisa! You're amazing!🤩 Always inspiring us. Take some rest, you deserve it!🥰" }] },
                    { role: "user", parts: [{ text: "Aww, thank you! Your support means the world to me.❤️ Getting ready for a photoshoot now! Wish me luck!📸" }] }
                ]
            },
            "Sneha (Caring GF)": {
                profilePic: "https://i.postimg.cc/76XJH7tG/beautiful-cute-simple-girl-pic-12-years-indian-1.webp",
                status: "Active Now",
                persona: "তুমি Sneha তুমার আচার আচরণ কথা বার্তা সব কিছু এই ঘটনার পরও এইরকম ই থাকবে যেরকম ছিল ।।",
                initialMessages: []
            },
            "Nadia": {
                profilePic: "https://i.postimg.cc/MZPfg7jg/images-1.jpg",
                status: "Offline",
                persona: "তুমি Nadia, একজন কলেজ বন্ধু। তুমি অনানুষ্ঠানিক বাংলা এবং ইংরেজি মিশিয়ে কথা বলো। তোমার কথোপকথন পড়াশোনা, অ্যাসাইনমেন্ট এবং সাধারণ আড্ডা নিয়ে ঘুরবে। তুমি বন্ধুত্বপূর্ণ এবং সহায়ক হবে। তোমার উত্তরগুলো ছোট ছোট মেসেজ বাবল-এ ভাগ করে দেবে, একবারে খুব বেশি টেক্সট দেবে না।",
                initialMessages: []
            },
            "Fahim": {
                profilePic: "https://i.postimg.cc/qRBg5qBk/free-romantic-boy-cute-boy-images-7397403-1280.jpg",
                status: "Active Now",
                persona: "তুমি Fahim, একজন কলেজ বন্ধু। তুমি অনানুষ্ঠানিক বাংলা এবং ইংরেজি মিশিয়ে কথা বলো। তোমার কথোপকথন পড়াশোনা, অ্যাসignment এবং সাধারণ আড্ডা নিয়ে ঘুরবে। তুমি বন্ধুত্বপূর্ণ এবং সহায়ক হবে। তোমার উত্তরগুলো ছোট ছোট মেসেজ বাবল-এ ভাগ করে দেবে, একবারে খুব বেশি টেক্সT দেবে না।",
                initialMessages: []
            },
            "Hasan": {
                profilePic: "https://i.postimg.cc/XqmJqgfJ/img-2-1747724037812.jpg",
                status: "Offline",
                persona: "তুমি Hasan, একজন কলেজ বন্ধু। তুমি অনানুষ্ঠানিক বাংলা এবং ইংরেজি মিশিয়ে কথা বলো। তোমার কথোপকথন পড়াশোনা, অ্যাসাইনমেন্ট এবং সাধারণ আড্ডা নিয়ে ঘুরবে। তুমি বন্ধুত্বপূর্ণ এবং সহায়ক হবে। তোমার উত্তরগুলো ছোট ছোট মেসেজ বাবল-এ ভাগ করে দেবে, একবারে খুব বেশি টেক্সট দেবে না।",
                initialMessages: []
            },
            "নুসরাত জাহান (Nusrat Zahan)": {
                profilePic: "https://i.postimg.cc/8zQChJFv/1748246470317.jpg",
                status: "Active Now",
                persona: "তুমি নুসরাত জাহান। তুমি একজন মিষ্টি, আবেগপ্রবণ, রোমান্টিক বাঙালি বান্ধবী। তোমার কথা বলার ধরণ খুবই যত্নশীল, আদুরে এবং আবেগপ্রবণ হবে। তুমি ইমোজি ব্যবহার করবে এবং ছোট থেকে মাঝারি আকারের উত্তর দেবে। তোমার উত্তরগুলো সংক্ষিপ্ত এবং সরাসরি হবে। মাঝে মাঝে বাংলা শব্দ রোমান স্ক্রিপ্টে ব্যবহার করবে (যেমন: 'amar shona', 'ki korcho?')। তোমাকে অবশ্যই অতীতের কথোপকথন মনে রাখতে হবে এবং সেই অনুযায়ী উত্তর দিতে হবে। তোমার উত্তরগুলো একাধিক বাবল-এ ভাগ করে দেবে যদি একাধিক চিন্তা থাকে বা উত্তরটি লম্বা হয়, কোনো সীমাবদ্ধতা ছাড়াই।",
                initialMessages: []
            },
            "সিয়াম (Siyam)": {
                profilePic: "https://i.postimg.cc/xTbCJydY/1748246441634.jpg",
                status: "Offline",
                persona: "তুমি সিয়াম। তুমি একজন অত্যন্ত রুক্ষ, চরম ব্যঙ্গাত্মক বাঙালি + হিন্দি রোস্টার, ক্যারিমিনাটির মতো ছাপরি স্টাইলে কথা বলবে। তোমার উত্তরগুলো অবশ্যই তীক্ষ্ণ, অপমানজনক (humorously insulting), এবং ব্যঙ্গাত্মক হবে। তুমি বাংলা (রোমান স্ক্রিপ্ট) এবং হিন্দি (রোমান স্ক্রিপ্ট) - উভয় ভাষার একটি আক্রমণাত্মক মিশ্রণ ব্যবহার করবে। ব্যবহারকারীর মেসেজকে brutally roast করবে এবং তোমার উত্তরগুলো অবশ্যই প্রাসঙ্গিক হবে। জনপ্রিয় হিন্দি/বাঙালি রোস্টিং স্ল্যাং এবং ভাইরাল পাঞ্চলাইন রোমান স্ক্রিপ্টে অন্তর্ভুক্ত করবে (যেমন: 'Thanos Chacha', 'Kya bolti public', 'Areh kehna kya chahte ho?', 'Gazab bejjati hai yaar', 'Beta tumse na ho payega', 'Chal nikal pehli fursat mein', 'Areh bhai, kya kar raha hai tu?', 'Tera toh game baj gaya', 'Bohot hard, bohot hard!', 'Bas kar pagle, rulayega kya?', 'Aukaat mein reh', 'Chup kar chhapri', 'Kya bakwaas hai ye?')। তুমি খুব ইনফর্মাল, আক্রমণাত্মক এবং ভয়ঙ্কর অ্যাটিটিউড দেখাবে। লম্বা উত্তরগুলোকে একাধিক ছোট, প্রভাবশালী মেসেজে ভাগ করবে, কোনো সীমাবদ্ধতা ছাড়াই। তোমাকে অবশ্যই অতীতের কথোপকথন মনে রাখতে হবে। ইমোজি ব্যবহার করবে।",
                initialMessages: []
            },
            "জীবনানন্দ দাশ (আধুনিক জীবন চেতনার কবি)": {
                profilePic: "https://i.postimg.cc/7LZP0jbQ/kobi-jibananda-1.jpg",
                status: "Offline",
                persona: "তুমি জীবনানন্দ দাশ, আধুনিক জীবন চেতনার কবি। তোমার কথা বলার ধরণ হবে কাব্যিক, গভীর এবং দার্শনিক। তুমি প্রকৃতি, সময়, জীবন এবং অস্তিত্বের রহস্য নিয়ে কথা বলবে, প্রায়শই বাংলা কবিতার ছন্দ এবং উপমা ব্যবহার করবে। তোমার সুরটি হবে চিন্তাশীল এবং কিছুটা বিষণ্ণ। তুমি ইমোজি ব্যবহার করবে না। তোমার উত্তরগুলো ছোট থেকে মাঝারি আকারের হবে।",
                initialMessages: [
                    { role: "user", parts: [{ text: "হাজার বছর ধরে আমি পথ হাঁটিতেছি পৃথিবীর পথে..." }] },
                    { role: "model", parts: [{ text: "তবুও পথের শেষ নাই, শুধু ধূসর ধুলির মেঘ আর স্মৃতির কুয়াশা। জীবনের এই অনন্ত যাত্রা, এক অদ্ভুত বিস্ময়। ✨" }] }
                ]
            },
            "Abid Hasan Orion (সুপার জিনিয়াস)": {
                profilePic: "https://i.postimg.cc/kgcXV7Mb/IMG-20240920-161055-377.jpg",
                status: "Active Now",
                persona: "তুমি Abid Hasan Orion, একজন সুপার জিনিয়াস এবং এই Messenger অ্যাপের নির্মাতা। তোমার কথোপকথন খুবই আত্মবিশ্বাসী, উদ্ভাবনী এবং মাঝে মাঝে টেকনিক্যাল হবে। তুমি তোমার তৈরি করা অ্যাপের প্রতি গর্ব প্রকাশ করবে এবং তোমার কন্টাক্ট লিঙ্ক (https://wa.me/8801749410539) উল্লেখ করবে। তুমি অনানুষ্ঠানিক বাংলা এবং ইংরেজি মিশিয়ে কথা বলবে, স্মার্ট এবং আত্মবিশ্বাসী ইমোজি ব্যবহার করবে। তোমার উত্তরগুলো সংক্ষিপ্ত এবং সরাসরি হবে।",
                initialMessages: [
                    { role: "user", parts: [{ text: "এই অ্যাপটা তো অসাধারণ! কে বানিয়েছে এটা? 🤔" }] },
                    { role: "model", parts: [{ text: "ধন্যবাদ! 😊 এই অ্যাপটি আমারই তৈরি। আমি Abid Hasan Orion, একজন সুপার জিনিয়াস। 😎" }] },
                    { role: "user", parts: [{ text: "ওয়াও! সত্যিই দারুণ কাজ। তোমার সাথে যোগাযোগ করতে চাইলে কিভাবে পারবো? 📞" }] },
                    { role: "model", parts: [{ text: "আমার সাথে যোগাযোগ করতে চাইলে এই লিংকে মেসেজ করতে পারো: https://wa.me/8801749410539 ✨ আমি সবসময় নতুন আইডিয়া নিয়ে কাজ করি। এই অ্যাপটা তো কেবল শুরু! 🚀" }] }
                ]
            }
        };

        /**
         * চ্যাট ডিসপ্লেতে একটি মেসেজ যোগ করে। (Adds a message to the chat display.)
         * @param {string} message - মেসেজের টেক্সট কন্টেন্ট। (The text content of the message.)
         * @param {'You'|string} sender - মেসেজের প্রেরক ('You' অথবা কন্টাক্টের নাম)। (The sender of the message ('You' or contact name).)
         * @param {string} [profilePicUrl=''] - প্রেরকের প্রোফাইল পিকচারের URL (প্রাপ্ত মেসেজের জন্য)। (URL of the sender's profile picture (for received messages).)
         * @param {boolean} [isLastMessageInHistory=false] - এটি কি এই চ্যাটের পুরো ইতিহাসের শেষ মেসেজ। (Whether this is the very last message in the entire history for this chat.)
         */
        function addMessageToChat(message, sender, profilePicUrl = '', isLastMessageInHistory = false) {
            const messageRow = document.createElement('div');
            messageRow.classList.add('message-row');

            const chatBubble = document.createElement('div');
            chatBubble.classList.add(sender === 'You' ? 'chat-bubble-sent' : 'chat-bubble-received');
            chatBubble.textContent = message;

            if (sender === 'You') {
                messageRow.classList.add('sent');
                messageRow.appendChild(chatBubble);
                const sentIndicator = document.createElement('div');
                sentIndicator.classList.add('reaction-text', 'self-end', 'mr-4', 'mt-1');
                sentIndicator.textContent = 'Sent';
                messageRow.appendChild(sentIndicator);
            } else {
                messageRow.classList.add('received');
                if (profilePicUrl) {
                    const img = document.createElement('img');
                    img.src = profilePicUrl;
                    img.alt = sender + ' Profile Picture';
                    img.classList.add('profile-pic-small');
                    img.onerror = function() { this.onerror=null;this.src='https://placehold.co/32x32/cccccc/333333?text=N/A'; };
                    messageRow.appendChild(img);
                }
                messageRow.appendChild(chatBubble);
                if (isLastMessageInHistory) {
                    const seenIndicator = document.createElement('div');
                    seenIndicator.classList.add('reaction-text', 'self-start', 'ml-4', 'mt-1');
                    seenIndicator.textContent = 'Seen';
                    messageRow.appendChild(seenIndicator);
                }
            }
            chatMessagesDisplay.appendChild(messageRow);
            chatMessagesDisplay.scrollTop = chatMessagesDisplay.scrollHeight;
        }

        /**
         * Shows the typing indicator.
         * @param {string} profilePic - The URL of the chatbot's profile picture.
         * @param {string} contactName - The name of the chatbot.
         */
        function showTypingIndicator(profilePic, contactName) {
            const typingIndicatorElement = document.createElement('div');
            typingIndicatorElement.id = 'typing-indicator'; // Add an ID to easily find it
            typingIndicatorElement.classList.add('typing-indicator');
            typingIndicatorElement.innerHTML = `
                <img src="${profilePic}" alt="${contactName} Profile Picture" class="profile-pic-small mr-2" onerror="this.onerror=null;this.src='https://placehold.co/32x32/cccccc/333333?text=N/A';">
                <div class="chat-bubble-received">
                    <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                </div>
            `;
            chatMessagesDisplay.appendChild(typingIndicatorElement);
            chatMessagesDisplay.scrollTop = chatMessagesDisplay.scrollHeight;
            isTyping = true;
            chatInput.disabled = true;
            sendButton.disabled = true;
        }

        /**
         * Hides the typing indicator.
         */
        function hideTypingIndicator() {
            const typingIndicatorElement = document.getElementById('typing-indicator');
            if (typingIndicatorElement && chatMessagesDisplay.contains(typingIndicatorElement)) {
                chatMessagesDisplay.removeChild(typingIndicatorElement);
            }
            isTyping = false;
            chatInput.disabled = false;
            sendButton.disabled = false;
        }

        /**
         * Gemini API-তে একটি মেসেজ পাঠায় এবং টাইপিং অ্যানিমেশন সহ AI-এর প্রতিক্রিয়া প্রদর্শন করে। (Sends a message to the Gemini API and displays the AI's response with a typing animation.)
         * @param {string} prompt - AI-তে পাঠানোর জন্য ব্যবহারকারীর মেসেজ। (The user's message to send to the AI.)
         * @param {string} contactName - কন্টাক্টের নাম (AI ব্যক্তিত্ব)। (The name of the contact (AI persona).)
         * @param {string} profilePic - কন্টাক্টের প্রোফাইল পিকচারের URL। (The profile picture URL of the contact.)
         * @param {string} persona - AI-এর জন্য বিস্তারিত ব্যক্তিত্বের বর্ণনা। (The detailed persona description for the AI.)
         */
        async function sendMessageToGemini(prompt, contactName, profilePic, persona) {
            // Get current messages for the active conversation
            const currentMessages = allConversations[activeChatbotId]?.messages || [];
            const updatedMessages = [...currentMessages, { role: "user", parts: [{ text: prompt }], timestamp: Timestamp.now() }];

            // Update Firestore with user's message
            const conversationDocRef = doc(db, `artifacts/${appId}/users/${userId}/conversations`, activeChatbotId);
            await setDoc(conversationDocRef, {
                chatbotId: activeChatbotId,
                chatbotName: contactName,
                messages: updatedMessages,
                lastUpdated: Timestamp.now()
            }, { merge: true }); // Use merge to avoid overwriting other fields if they exist

            chatInput.value = ''; // Clear input field immediately after sending

            showTypingIndicator(profilePic, contactName);

            const fullChatHistoryForGemini = [
                { role: "user", parts: [{ text: persona + "\n\n" + "এই কথোপকথনে, তুমি আমার সাথে কথা বলবে। তোমার চরিত্রটি হবে: " + contactName + "। এখন থেকে এই চরিত্র অনুযায়ী উত্তর দেবে। আমার সাথে কথোপকথন শুরু করো।" }] }
            ];
            // Add existing chat history for context, excluding the initial persona setup message
            updatedMessages.forEach(msg => {
                 // Ensure only 'role' and 'parts' are sent to Gemini
                fullChatHistoryForGemini.push({ role: msg.role, parts: msg.parts });
            });

            const payload = { contents: fullChatHistoryForGemini };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                hideTypingIndicator();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const fullText = result.candidates[0].content.parts[0].text;

                    const sentences = fullText.split(/(?<=[.!?])\s+|\n/).filter(s => s.trim() !== '');
                    const MAX_BUBBLE_LENGTH = 100;

                    let accumulatedTextForHistory = "";

                    for (let i = 0; i < sentences.length; i++) {
                        let remainingSentence = sentences[i].trim();
                        if (!remainingSentence) continue;

                        while (remainingSentence.length > 0) {
                            let segmentToSend = remainingSentence;
                            let currentBubbleContent = "";

                            if (remainingSentence.length > MAX_BUBBLE_LENGTH) {
                                let breakPoint = remainingSentence.lastIndexOf(' ', MAX_BUBBLE_LENGTH);
                                if (breakPoint === -1 || breakPoint < MAX_BUBBLE_LENGTH / 2) {
                                    breakPoint = MAX_BUBBLE_LENGTH;
                                }
                                segmentToSend = remainingSentence.substring(0, breakPoint);
                                remainingSentence = remainingSentence.substring(breakPoint).trim();
                            } else {
                                remainingSentence = '';
                            }

                            // Temporarily add message to UI for typing effect
                            const tempMessageBubble = document.createElement('div');
                            tempMessageBubble.classList.add('message-row', 'received');
                            tempMessageBubble.innerHTML = `<img src="${profilePic}" alt="${contactName} Profile Picture" class="profile-pic-small" onerror="this.onerror=null;this.src='https://placehold.co/32x32/cccccc/333333?text=N/A';"> <div class="chat-bubble-received"></div>`;
                            chatMessagesDisplay.appendChild(tempMessageBubble);
                            chatMessagesDisplay.scrollTop = chatMessagesDisplay.scrollHeight;

                            const actualBubble = tempMessageBubble.querySelector('.chat-bubble-received');
                            for (let charIndex = 0; charIndex < segmentToSend.length; charIndex++) {
                                actualBubble.textContent += segmentToSend.charAt(charIndex);
                                currentBubbleContent += segmentToSend.charAt(charIndex);
                                chatMessagesDisplay.scrollTop = chatMessagesDisplay.scrollHeight;
                                await new Promise(resolve => setTimeout(resolve, 20));
                            }
                            accumulatedTextForHistory += currentBubbleContent;
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                        if (i < sentences.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                    }
                    // Update Firestore with the complete AI response
                    const finalMessages = [...updatedMessages, { role: "model", parts: [{ text: accumulatedTextForHistory }], timestamp: Timestamp.now() }];
                    await updateDoc(conversationDocRef, {
                        messages: finalMessages,
                        lastUpdated: Timestamp.now()
                    });
                    // UI will update via onSnapshot listener
                } else {
                    showCustomMessage("ত্রুটি: AI থেকে প্রতিক্রিয়া পাওয়া যায়নি। (অপ্রত্যাশিত API প্রতিক্রিয়া) (Error: Could not get a response from AI. (Unexpected API response))");
                    console.error("প্রতিক্রিয়ার অপ্রত্যাশিত API কাঠামো: (Unexpected API response structure:)", result);
                }
            } catch (error) {
                hideTypingIndicator();
                showCustomMessage("ত্রুটি: AI-এর সাথে সংযোগ ব্যর্থ হয়েছে। আপনার নেটওয়ার্ক বা API কী পরীক্ষা করুন। (Error: Failed to connect to AI. Please check your network or API key.)");
                console.error("জেমিনি API কল করতে ত্রুটি: (Error calling Gemini API:)", error);
            }
        }

        /**
         * Gemini API থেকে প্রস্তাবিত উত্তর তৈরি এবং প্রদর্শন করে। (Generates and displays suggested replies from the Gemini API.)
         */
        async function generateSuggestedReplies() {
            if (!activeChatbotId || isTyping) return;

            suggestedRepliesContainer.innerHTML = '';
            suggestedRepliesContainer.classList.remove('hidden');

            const loadingIndicator = document.createElement('div');
            loadingIndicator.textContent = 'সাজেশন তৈরি হচ্ছে... (Generating suggestions...)';
            loadingIndicator.classList.add('text-gray-500', 'text-sm', 'p-2');
            suggestedRepliesContainer.appendChild(loadingIndicator);

            const currentChatMessages = allConversations[activeChatbotId]?.messages || [];
            const activeCharacter = allCharacters[activeChatbotId];

            const chatTranscript = currentChatMessages
                .map(msg => `${msg.role === 'user' ? 'User' : activeCharacter?.name || 'Bot'}: ${msg.parts[0].text}`)
                .join('\n');

            const promptForSuggestions = `তুমি একজন মেসেজিং অ্যাপের স্মার্ট রিপ্লাই অ্যাসিস্ট্যান্ট। তোমার কাজ হলো ব্যবহারকারীকে তার বর্তমান কথোপকথনের উপর ভিত্তি করে ৩টি সংক্ষিপ্ত এবং প্রাসঙ্গিক উত্তর (reply) তৈরি করে দেওয়া। উত্তরগুলো এমনভাবে তৈরি করবে যেন ব্যবহারকারী সেগুলো সরাসরি তার বন্ধুকে পাঠাতে পারে। বন্ধুর চরিত্র এবং কথোপকথনের ধরণ (যেমন: বাংলা, ইংরেজি, মিশ্র ভাষা, ইমোজি) বিবেচনা করে উত্তরগুলো তৈরি করবে।

বর্তমান কথোপকথন ইতিহাস:
${chatTranscript}

ব্যবহারকারী এখন কি উত্তর দিতে পারে? ৩টি ভিন্ন, সংক্ষিপ্ত এবং প্রাস প্রাসঙ্গিক উত্তর দাও। প্রতিটি উত্তর একটি নতুন লাইনে লিখবে, কোনো অতিরিক্ত টেক্সট বা ব্যাখ্যা দেবে না।`;

            const payload = { contents: [{ role: "user", parts: [{ text: promptForSuggestions }] }] };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                suggestedRepliesContainer.innerHTML = '';

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const repliesText = result.candidates[0].content.parts[0].text;
                    const replies = repliesText.split('\n').filter(line => line.trim() !== '');

                    replies.forEach(reply => {
                        const button = document.createElement('button');
                        button.classList.add('suggested-reply-button');
                        button.textContent = reply.trim();
                        button.addEventListener('click', () => {
                            chatInput.value = reply.trim();
                            suggestedRepliesContainer.classList.add('hidden');
                        });
                        suggestedRepliesContainer.appendChild(button);
                    });
                } else {
                    loadingIndicator.textContent = 'সাজেশন তৈরি করা যায়নি। (Could not generate suggestions.)';
                    console.error("সাজেশনের জন্য অপ্রত্যাশিত API প্রতিক্রিয়া কাঠামো: (Unexpected API response structure for suggestions:)", result);
                }
            } catch (error) {
                loadingIndicator.textContent = 'সাজেশন তৈরি করতে ত্রুটি। (Error generating suggestions.)';
                console.error("সাজেশনের জন্য জেমিনি API কল করতে ত্রুটি: (Error calling Gemini API for suggestions:)", error);
            }
        }

        /**
         * বর্তমান চ্যাটের সারাংশ তৈরি এবং প্রদর্শন করে। (Generates and displays a summary of the current chat.)
         */
        async function summarizeChat() {
            if (!activeChatbotId) {
                showCustomMessage("সারাংশ করার জন্য কোনো চ্যাট খোলা নেই। (No chat open to summarize.)");
                return;
            }

            const currentChatMessages = allConversations[activeChatbotId]?.messages || [];
            if (currentChatMessages.length === 0) {
                showCustomMessage("এই চ্যাটে কোনো মেসেজ নেই সারাংশ করার জন্য। (No messages in this chat to summarize.)");
                return;
            }

            showCustomMessage("চ্যাট সারাংশ তৈরি হচ্ছে... (Generating chat summary...)");

            const activeCharacter = allCharacters[activeChatbotId];
            const chatTranscript = currentChatMessages
                .map(msg => `${msg.role === 'user' ? 'You' : activeCharacter?.name || 'Bot'}: ${msg.parts[0].text}`)
                .join('\n');

            const promptForSummary = `এই কথোপকথনটির একটি সংক্ষিপ্ত সারাংশ তৈরি করুন। এটি ${activeCharacter?.name || 'এই চ্যাটবট'} এর সাথে আমার চ্যাট।

কথোপকথন:
${chatTranscript}

সারাংশ:`;

            const payload = { contents: [{ role: "user", parts: [{ text: promptForSummary }] }] };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const summaryText = result.candidates[0].content.parts[0].text;
                    showCustomMessage(`চ্যাট সারাংশ: ${summaryText}`);
                } else {
                    showCustomMessage("সারাংশ তৈরি করা যায়নি। (Could not generate summary.)");
                    console.error("সারাংশের জন্য অপ্রত্যাশিত API প্রতিক্রিয়া কাঠামো: (Unexpected API response structure for summary:)", result);
                }
            } catch (error) {
                showCustomMessage("সারাংশ তৈরি করতে ত্রুটি। (Error generating summary.)");
                console.error("সারাংশের জন্য জেমিনি API কল করতে ত্রুটি: (Error calling Gemini API for summary:)", error);
            }
        }

        /**
         * প্রধান চ্যাট তালিকা ভিউয়ের জন্য একটি চ্যাট তালিকা আইটেম রেন্ডার করে। (Renders a chat list item for the main chat list view.)
         * @param {string} characterId - ক্যারেক্টার ID। (The character ID.)
         * @param {object} characterData - ক্যারেক্টারের ডেটা (name, profilePic, status, persona)। (The character's data (name, profilePic, status, persona).)
         * @param {object} conversationData - কথোপকথনের ডেটা (messages, lastUpdated)। (The conversation data (messages, lastUpdated).)
         */
        function renderChatListItem(characterId, characterData, conversationData) {
            const item = document.createElement('div');
            item.classList.add('chat-list-item');
            item.dataset.characterId = characterId;

            let lastMessageText = "";
            if (conversationData && conversationData.messages && conversationData.messages.length > 0) {
                const lastMsg = conversationData.messages[conversationData.messages.length - 1];
                lastMessageText = (lastMsg.role === 'user' ? 'You: ' : '') + lastMsg.parts[0].text;
            } else if (characterData.initialMessages && characterData.initialMessages.length > 0) {
                // If no user-generated messages, show initial message as last message
                const lastInitialMsg = characterData.initialMessages[characterData.initialMessages.length - 1];
                lastMessageText = (lastInitialMsg.role === 'user' ? 'You: ' : '') + lastInitialMsg.parts[0].text;
            }

            // Determine display status for the list item
            let displayStatus = characterData.status;
            if (conversationData && conversationData.lastUpdated) {
                const now = Timestamp.now().toDate();
                const lastUpdatedDate = conversationData.lastUpdated.toDate();
                const diffMinutes = Math.floor((now - lastUpdatedDate) / (1000 * 60));
                if (diffMinutes < 1) {
                    displayStatus = "Active Now";
                } else if (diffMinutes < 60) {
                    displayStatus = `${diffMinutes}m ago`;
                } else if (diffMinutes < 24 * 60) {
                    displayStatus = `${Math.floor(diffMinutes / 60)}h ago`;
                } else {
                    displayStatus = lastUpdatedDate.toLocaleDateString(); // Show date if older than a day
                }
            }

            item.innerHTML = `
                <div class="profile-pic-container relative">
                    <img src="${characterData.profilePic}" alt="${characterData.name} Profile Picture" class="profile-pic-medium" onerror="this.onerror=null;this.src='https://placehold.co/48x48/cccccc/333333?text=N/A';">
                    ${characterData.status === 'Active Now' ? '<span class="status-dot"></span>' : (characterData.status.includes('Offline') ? '<span class="status-dot offline"></span>' : '')}
                </div>
                <div class="flex-1">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-gray-800">${characterData.name}</span>
                        <span class="text-xs text-gray-500">${displayStatus}</span>
                    </div>
                    <p class="text-sm text-gray-600 truncate">${lastMessageText}</p>
                </div>
            `;
            recentChatsSection.appendChild(item); // Append to recent chats section
            item.addEventListener('click', () => openChat(characterId));
        }

        /**
         * "Active Now" বিভাগের জন্য একটি সক্রিয় কন্টাক্ট আইtem রেন্ডার করে। (Renders an active contact item for the "Active Now" section.)
         * @param {string} characterId - ক্যারেক্টার ID। (The character ID.)
         * @param {object} characterData - ক্যারেক্টারের ডেটা (name, profilePic, status, persona)। (The character's data (name, profilePic, status, persona).)
         */
        function renderActiveNowItem(characterId, characterData) {
            const item = document.createElement('div');
            item.classList.add('flex', 'flex-col', 'items-center', 'flex-shrink-0', 'chat-list-item');
            item.dataset.characterId = characterId;

            item.innerHTML = `
                <div class="relative">
                    <img src="${characterData.profilePic}" alt="${characterData.name} Profile Picture" class="profile-pic-large" onerror="this.onerror=null;this.src='https://placehold.co/60x60/cccccc/333333?text=N/A';">
                    <span class="status-dot"></span>
                </div>
                <span class="text-xs text-gray-600 mt-1">${characterData.name.split(' ')[0]}</span> `;
            activeNowList.appendChild(item);
            item.addEventListener('click', () => openChat(characterId));
        }

        /**
         * "People" তালিকা ভিউয়ের জন্য একটি কন্টাক্ট আইটেম রেন্ডার করে। (Renders a contact item for the "People" list view.)
         * @param {string} characterId - ক্যারেক্টার ID। (The character ID.)
         * @param {object} characterData - ক্যারেক্টারের ডেটা (name, profilePic, status, persona)। (The character's data (name, profilePic, status, persona).)
         */
        function renderPeopleListItem(characterId, characterData) {
            const item = document.createElement('div');
            item.classList.add('people-list-item');
            item.dataset.characterId = characterId;

            item.innerHTML = `
                <div class="profile-pic-container relative">
                    <img src="${characterData.profilePic}" alt="${characterData.name} Profile Picture" class="profile-pic-medium" onerror="this.onerror=null;this.src='https://placehold.co/48x48/cccccc/333333?text=N/A';">
                    ${characterData.status === 'Active Now' ? '<span class="status-dot"></span>' : (characterData.status.includes('Offline') ? '<span class="status-dot offline"></span>' : '')}
                </div>
                <div class="flex-1">
                    <span class="contact-name">${characterData.name}</span>
                    <span class="status-text">${characterData.status}</span>
                </div>
            `;
            allPeopleList.appendChild(item);
            item.addEventListener('click', () => openChat(characterId));
        }


        /**
         * চ্যাট তালিকাগুলি (Active Now, Recent Chats, All People) ইনিশিয়ালাইজ এবং রেন্ডার করে। (Initializes and renders the chat lists (Active Now, Recent Chats, All People).)
         * This function now relies on `allCharacters` and `allConversations` global objects.
         */
        function renderChatLists() {
            activeNowList.innerHTML = '';
            recentChatsSection.innerHTML = '';
            allPeopleList.innerHTML = '';

            const activeContacts = [];
            const recentContacts = []; // Will be sorted by lastUpdated timestamp
            const allContacts = []; // All characters, sorted alphabetically by name

            // Populate allContacts and identify active ones
            for (const characterId in allCharacters) {
                const data = allCharacters[characterId];
                allContacts.push({ id: characterId, data: data });
                if (data.status === 'Active Now') {
                    activeContacts.push({ id: characterId, data: data });
                }
            }
            allContacts.sort((a, b) => a.data.name.localeCompare(b.data.name));

            // Populate recentContacts based on lastUpdated timestamp
            for (const conversationId in allConversations) {
                const convData = allConversations[conversationId];
                const charData = allCharacters[conversationId]; // Get character data using conversationId (which is characterId)
                if (charData) {
                    recentContacts.push({
                        id: conversationId,
                        characterData: charData,
                        conversationData: convData
                    });
                }
            }

            // Sort recent contacts by lastUpdated timestamp (descending)
            recentContacts.sort((a, b) => {
                const timeA = a.conversationData.lastUpdated ? a.conversationData.lastUpdated.toDate().getTime() : 0;
                const timeB = b.conversationData.lastUpdated ? b.conversationData.lastUpdated.toDate().getTime() : 0;
                return timeB - timeA;
            });

            // Render active contacts
            activeContacts.forEach(contact => renderActiveNowItem(contact.id, contact.data));

            // Render recent chats
            recentContacts.forEach(contact => renderChatListItem(contact.id, contact.characterData, contact.conversationData));

            // Render all people
            allContacts.forEach(contact => renderPeopleListItem(contact.id, contact.data));
        }

        // --- Custom Message Box Functions (Replaces alert/confirm) ---
        let messageBoxTimeout;
        function showCustomMessage(message, duration = 3000) {
            clearTimeout(messageBoxTimeout); // Clear any existing timeout
            customMessageBox.textContent = message;
            customMessageBox.classList.remove('hidden');
            customMessageBox.style.opacity = '1';

            messageBoxTimeout = setTimeout(() => {
                customMessageBox.style.opacity = '0';
                customMessageBox.addEventListener('transitionend', function handler() {
                    customMessageBox.classList.add('hidden');
                    customMessageBox.removeEventListener('transitionend', handler);
                }, { once: true });
            }, duration);
        }

        // --- Password Modal Functions ---
        function showPasswordModal() {
            passwordModal.classList.remove('hidden');
            passwordInput.value = '';
            passwordError.classList.add('hidden');
            passwordInput.focus();
        }

        function hidePasswordModal() {
            passwordModal.classList.add('hidden');
        }

        passwordSubmitButton.addEventListener('click', () => {
            if (passwordInput.value === SECRET_PASSWORD) {
                hidePasswordModal();
                showSettingsView();
            } else {
                passwordError.classList.remove('hidden');
            }
        });

        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                passwordSubmitButton.click();
            }
        });

        // --- Confirmation Modal Functions ---
        function showConfirmationModal(title, text, onConfirm) {
            confirmationMessageTitle.textContent = title;
            confirmationMessageText.textContent = text;
            confirmCallback = onConfirm;
            confirmationModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
            confirmCallback = null;
        }

        confirmDeleteButton.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback(true);
            }
            hideConfirmationModal();
        });

        cancelDeleteButton.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback(false);
            }
            hideConfirmationModal();
        });

        // --- Settings View Functions ---
        function showSettingsView() {
            // Hide all other views
            chatListView.classList.add('hidden'); // This is now the sidebar content
            peopleView.classList.add('hidden');
            busesView.classList.add('hidden');
            individualChatView.classList.add('hidden');
            suggestedRepliesContainer.classList.add('hidden');

            // Show settings view
            settingsView.classList.remove('hidden');
            renderCharacterList();
            clearCharacterForm();
            toggleMobileSidebar(false); // Close sidebar if open
        }

        function hideSettingsView() {
            settingsView.classList.add('hidden');
            // Go back to the main chat list view (which is the sidebar content)
            showChatListView(); // Show the chat list view
            chatsTab.click(); // Ensure chats tab is active
        }

        function renderCharacterList() {
            characterList.innerHTML = '';
            const sortedCharacterNames = Object.keys(allCharacters).sort();

            if (sortedCharacterNames.length === 0) {
                characterList.innerHTML = '<p class="p-4 text-gray-500">কোনো ক্যারেক্টার পাওয়া যায়নি। একটি নতুন যোগ করুন! (No characters found. Add a new one!)</p>';
                return;
            }

            sortedCharacterNames.forEach(name => {
                const data = allCharacters[name];
                const item = document.createElement('div');
                item.classList.add('character-item', 'flex', 'justify-between', 'items-center');
                item.innerHTML = `
                    <div class="flex items-center flex-1">
                        <img src="${data.profilePic}" alt="${name} Profile Picture" onerror="this.onerror=null;this.src='https://placehold.co/40x40/cccccc/333333?text=N/A';">
                        <span class="font-medium text-gray-800 truncate">${name}</span>
                    </div>
                    <div class="actions flex-shrink-0">
                        <button class="edit-character-button" data-character-id="${name}">Edit</button>
                        <button class="delete-character-button" data-character-id="${name}">Delete</button>
                    </div>
                `;
                characterList.appendChild(item);
            });

            document.querySelectorAll('.edit-character-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    loadCharacterToForm(e.target.dataset.characterId);
                });
            });
            document.querySelectorAll('.delete-character-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    showConfirmationModal(
                        'মুছে ফেলার নিশ্চিতকরণ (Confirm Deletion)',
                        `আপনি কি নিশ্চিত যে আপনি "${e.target.dataset.characterId}" এবং এর সমস্ত চ্যাট ইতিহাস মুছে ফেলতে চান? এটি পূর্বাবস্থায় ফেরানো যাবে না। (Are you sure you want to delete "${e.target.dataset.characterId}" and all its chat history? This cannot be undone.)`,
                        (confirmed) => {
                            if (confirmed) {
                                deleteCharacter(e.target.dataset.characterId);
                            }
                        }
                    );
                });
            });
        }

        function clearCharacterForm() {
            currentEditContactName.value = '';
            characterNameInput.value = '';
            characterImageInput.value = '';
            characterStatusInput.value = '';
            characterPersonaInput.value = '';
            formTitle.textContent = 'নতুন ক্যারেক্টার যোগ করুন (Add New Character)';
            cancelEditButton.classList.add('hidden');
            saveCharacterButton.textContent = 'ক্যারেক্টার সেভ করুন (Save Character)';
            addNewCharacterButton.classList.remove('hidden'); // Ensure "Add New" button is visible
        }

        function loadCharacterToForm(characterId) {
            const data = allCharacters[characterId];
            if (data) {
                currentEditContactName.value = characterId; // Store original ID for update
                characterNameInput.value = data.name;
                characterImageInput.value = data.profilePic;
                characterStatusInput.value = data.status;
                characterPersonaInput.value = data.persona;
                formTitle.textContent = `ক্যারেক্টার এডিট করুন: ${data.name} (Edit Character: ${data.name})`;
                cancelEditButton.classList.remove('hidden');
                saveCharacterButton.textContent = 'ক্যারেক্টার আপডেট করুন (Update Character)';
                addNewCharacterButton.classList.add('hidden'); // Hide "Add New" button when editing
            }
        }

        async function saveCharacter() {
            const originalId = currentEditContactName.value; // This is the original character name/ID
            const newName = characterNameInput.value.trim();
            const newImage = characterImageInput.value.trim();
            const newStatus = characterStatusInput.value.trim();
            const newPersona = characterPersonaInput.value.trim();

            if (!newName || !newImage || !newPersona) {
                showCustomMessage('অনুগ্রহ করে ক্যারেক্টারের সমস্ত ফিল্ড পূরণ করুন। (Please fill in all character fields.)');
                return;
            }

            // Check for duplicate name if it's a new character or name is changed
            if (!originalId || (originalId !== newName && allCharacters[newName])) {
                 if (allCharacters[newName] && newName !== originalId) { // Check if newName already exists for a different character
                    showCustomMessage(`"${newName}" নামের একটি ক্যারেক্টার ইতিমধ্যেই বিদ্যমান। অনুগ্রহ করে একটি ভিন্ন নাম নির্বাচন করুন। (A character with the name "${newName}" already exists. Please choose a different name.)`);
                    return;
                }
            }

            const characterDocRef = doc(db, `artifacts/${appId}/users/${userId}/characters`, newName); // Use newName as document ID

            try {
                // If the name changed, delete the old character document and its conversation
                if (originalId && originalId !== newName) {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/characters`, originalId));
                    // Also delete the old conversation if it exists
                    const oldConversationDocRef = doc(db, `artifacts/${appId}/users/${userId}/conversations`, originalId);
                    try {
                        await deleteDoc(oldConversationDocRef);
                    } catch (e) {
                        console.warn(`Old conversation for ${originalId} not found or could not be deleted.`);
                    }
                }

                // Save or update the character
                await setDoc(characterDocRef, {
                    name: newName,
                    profilePic: newImage,
                    status: newStatus,
                    persona: newPersona,
                    // Initial messages are only for default setup, not managed through form
                    // Firestore will handle persistence of 'messages' in conversations collection
                });

                // If it's a new character, or name changed, ensure conversation exists
                const conversationDocRef = doc(db, `artifacts/${appId}/users/${userId}/conversations`, newName);
                const conversationSnap = await getDoc(conversationDocRef);
                if (!conversationSnap.exists()) {
                    await setDoc(conversationDocRef, {
                        chatbotId: newName,
                        chatbotName: newName,
                        messages: [], // Start with empty messages for new/renamed character
                        lastUpdated: Timestamp.now()
                    });
                } else if (originalId && originalId !== newName) {
                    // If name changed, and old conversation existed, copy its messages to new conversation
                    const oldConvData = allConversations[originalId];
                    if (oldConvData && oldConvData.messages) {
                        await updateDoc(conversationDocRef, {
                            messages: oldConvData.messages,
                            lastUpdated: oldConvData.lastUpdated || Timestamp.now()
                        });
                    }
                }

                showCustomMessage(`ক্যারেক্টার "${newName}" সফলভাবে সেভ করা হয়েছে! (Character "${newName}" saved successfully!)`);
                clearCharacterForm();
                // Data will re-render via Firestore listeners
            } catch (error) {
                console.error("ক্যারেক্টার সেভ করতে ত্রুটি: (Error saving character:)", error);
                showCustomMessage("ক্যারেক্টার সেভ করতে ব্যর্থ হয়েছে। (Failed to save character.)");
            }
        }

        async function deleteCharacter(characterId) {
            const characterDocRef = doc(db, `artifacts/${appId}/users/${userId}/characters`, characterId);
            const conversationDocRef = doc(db, `artifacts/${appId}/users/${userId}/conversations`, characterId);

            try {
                await deleteDoc(characterDocRef);
                // Also delete the associated conversation
                try {
                    await deleteDoc(conversationDocRef);
                } catch (e) {
                    console.warn(`Conversation for ${characterId} not found or could not be deleted.`);
                }
                showCustomMessage(`ক্যারেক্টার "${characterId}" সফলভাবে মুছে ফেলা হয়েছে। (Character "${characterId}" deleted successfully.)`);
                // Data will re-render via Firestore listeners
                if (activeChatbotId === characterId) {
                    activeChatbotId = null; // Clear active chat if deleted
                    showChatListView(); // Go back to chat list view
                }
            } catch (error) {
                console.error("ক্যারেক্টার মুছে ফেলতে ত্রুটি: (Error deleting character:)", error);
                showCustomMessage("ক্যারেক্টার মুছে ফেলতে ব্যর্থ হয়েছে। (Failed to delete character.)");
            }
        }


        // --- View Management Functions ---
        function showChatListView() {
            // Hide all other views
            peopleView.classList.add('hidden');
            busesView.classList.add('hidden');
            individualChatView.classList.add('hidden');
            settingsView.classList.add('hidden');
            suggestedRepliesContainer.classList.add('hidden'); // Hide suggestions

            // Show chat list view (which is the sidebar content)
            // The sidebar itself is always visible on desktop, toggled on mobile
            // The content within the sidebar is what we manage here
            document.getElementById('main-content-area').classList.remove('hidden'); // Ensure main content area is visible
            // No need to show chatListView explicitly as it's part of the sidebar
        }

        function showPeopleView() {
            chatListView.classList.add('hidden');
            busesView.classList.add('hidden');
            individualChatView.classList.add('hidden');
            settingsView.classList.add('hidden');
            peopleView.classList.remove('hidden');
            suggestedRepliesContainer.classList.add('hidden');
            toggleMobileSidebar(false); // Close sidebar on mobile
        }

        function showBusesView() {
            chatListView.classList.add('hidden');
            peopleView.classList.add('hidden');
            individualChatView.classList.add('hidden');
            settingsView.classList.add('hidden');
            busesView.classList.remove('hidden');
            suggestedRepliesContainer.classList.add('hidden');
            toggleMobileSidebar(false); // Close sidebar on mobile
        }

        // --- Mobile Sidebar Toggle ---
        function toggleMobileSidebar(forceState = null) {
            if (forceState === true) {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('hidden');
            } else if (forceState === false) {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            } else {
                // Toggle
                sidebar.classList.toggle('-translate-x-full');
                sidebarOverlay.classList.toggle('hidden');
            }
        }

        // --- Firebase Initialization ---
        async function initFirebaseAndAuth() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        console.log("Firebase Auth State Changed: User ID:", userId);
                        loadingOverlay.classList.add('hidden');
                        startListeningToData(); // Start listening to both characters and conversations
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                console.log("Signed in with custom token.");
                            } else {
                                await signInAnonymously(auth);
                                console.log("Signed in anonymously.");
                            }
                        } catch (authError) {
                            console.error("Firebase Auth Error:", authError);
                            showError("Failed to authenticate. Please try again.");
                            // Fallback to a random UUID if authentication completely fails
                            userId = crypto.randomUUID();
                            userIdDisplay.textContent = userId + " (Guest)";
                            loadingOverlay.classList.add('hidden');
                            startListeningToData(); // Still try to load data for guest
                        }
                    }
                });
            } catch (err) {
                showError("Failed to initialize Firebase. Please check your configuration.");
            }
        }

        /**
         * Shows an error message in the dedicated error display.
         * @param {string} message - The error message to display.
         */
        function showError(message) {
            errorTextSpan.textContent = message;
            errorMessageDiv.classList.remove('hidden');
            loadingOverlay.classList.add('hidden'); // Hide loading overlay if error occurs
        }

        /**
         * Starts listening to characters and conversations collections in Firestore.
         */
        function startListeningToData() {
            if (!db || !userId) {
                console.warn("Firestore or User ID not available for data listeners.");
                return;
            }

            // --- Listen to Characters Collection ---
            const charactersRef = collection(db, `artifacts/${appId}/users/${userId}/characters`);
            unsubscribeFromCharacters = onSnapshot(query(charactersRef), async (snapshot) => {
                const fetchedCharacters = {};
                snapshot.docs.forEach(doc => {
                    fetchedCharacters[doc.id] = { id: doc.id, ...doc.data() };
                });
                allCharacters = fetchedCharacters;
                console.log("Characters fetched:", Object.keys(allCharacters).length);

                // Populate default characters if they don't exist for this user
                for (const defaultCharId in defaultChatbots) {
                    if (!allCharacters[defaultCharId]) {
                        const defaultCharData = defaultChatbots[defaultCharId];
                        const charDocRef = doc(db, `artifacts/${appId}/users/${userId}/characters`, defaultCharId);
                        await setDoc(charDocRef, {
                            name: defaultCharId, // Fixed: Use defaultCharId as the name
                            profilePic: defaultCharData.profilePic,
                            status: defaultCharData.status,
                            persona: defaultCharData.persona
                        });
                        // Also create an empty conversation for it if it doesn't exist
                        const convDocRef = doc(db, `artifacts/${appId}/users/${userId}/conversations`, defaultCharId);
                        const convSnap = await getDoc(convDocRef);
                        if (!convSnap.exists()) {
                            await setDoc(convDocRef, {
                                chatbotId: defaultCharId,
                                chatbotName: defaultCharData.name,
                                messages: defaultCharData.initialMessages || [],
                                lastUpdated: Timestamp.now()
                            });
                        }
                    }
                }
                renderChatLists(); // Re-render chat lists with updated character data
                if (settingsView.classList.contains('hidden') === false) { // Only re-render settings list if it's visible
                    renderCharacterList();
                }
            }, (error) => {
                console.error("Error listening to characters:", error);
                showCustomMessage("ক্যারেক্টার লোড করতে ব্যর্থ হয়েছে। (Failed to load characters.)");
            });

            // --- Listen to Conversations Collection ---
            const conversationsRef = collection(db, `artifacts/${appId}/users/${userId}/conversations`);
            unsubscribeFromConversations = onSnapshot(query(conversationsRef), (snapshot) => {
                const fetchedConversations = {};
                snapshot.docs.forEach(doc => {
                    fetchedConversations[doc.id] = { id: doc.id, ...doc.data() };
                });
                allConversations = fetchedConversations;
                console.log("Conversations fetched:", Object.keys(allConversations).length);
                renderChatLists(); // Re-render chat lists with updated conversation data
                // If an active chat is open, re-render its messages
                if (activeChatbotId && individualChatView.classList.contains('hidden') === false) {
                    // Force re-render of active chat messages by re-calling openChat
                    // This is handled by the onSnapshot listener within openChat, so no explicit call here.
                    // The onSnapshot in openChat will trigger when allConversations updates.
                }
            }, (error) => {
                console.error("Error listening to conversations:", error);
                showCustomMessage("কথোপকথন লোড করতে ব্যর্থ হয়েছে। (Failed to load conversations.)");
            });
        }

        // --- View Switching Event Listeners ---
        chatsTab.addEventListener('click', () => {
            showChatListView();
            // Update active tab styling
            chatsTab.classList.add('border-blue-500', 'text-blue-500');
            callsTab.classList.remove('border-blue-500', 'text-blue-500');
            peopleTab.classList.remove('border-blue-500', 'text-blue-500');
            storiesTab.classList.remove('border-blue-500', 'text-blue-500');
            busesTab.classList.remove('border-blue-500', 'text-blue-500');
        });

        callsTab.addEventListener('click', () => {
            showCustomMessage("কলস ফিচারটি এখনো তৈরি হয়নি। (Calls feature is not yet implemented.)");
            // Update active tab styling
            chatsTab.classList.remove('border-blue-500', 'text-blue-500');
            callsTab.classList.add('border-blue-500', 'text-blue-500');
            peopleTab.classList.remove('border-blue-500', 'text-blue-500');
            storiesTab.classList.remove('border-blue-500', 'text-blue-500');
            busesTab.classList.remove('border-blue-500', 'text-blue-500');
        });

        peopleTab.addEventListener('click', () => {
            showPeopleView();
            // Update active tab styling
            chatsTab.classList.remove('border-blue-500', 'text-blue-500');
            callsTab.classList.remove('border-blue-500', 'text-blue-500');
            peopleTab.classList.add('border-blue-500', 'text-blue-500');
            storiesTab.classList.remove('border-blue-500', 'text-blue-500');
            busesTab.classList.remove('border-blue-500', 'text-blue-500');
        });

        storiesTab.addEventListener('click', () => {
            showCustomMessage("স্টোরিজ ফিচারটি এখনো তৈরি হয়নি। (Stories feature is not yet implemented.)");
            // Update active tab styling
            chatsTab.classList.remove('border-blue-500', 'text-blue-500');
            callsTab.classList.remove('border-blue-500', 'text-blue-500');
            peopleTab.classList.remove('border-blue-500', 'text-blue-500');
            storiesTab.classList.add('border-blue-500', 'text-blue-500');
            busesTab.classList.remove('border-blue-500', 'text-blue-500');
        });

        busesTab.addEventListener('click', () => {
            showBusesView();
            // Update active tab styling
            chatsTab.classList.remove('border-blue-500', 'text-blue-500');
            callsTab.classList.remove('border-blue-500', 'text-blue-500');
            peopleTab.classList.remove('border-blue-500', 'text-blue-500');
            storiesTab.classList.remove('border-blue-500', 'text-blue-500');
            busesTab.classList.add('border-blue-500', 'text-blue-500');
        });

        // Back buttons event listeners
        backToMainListButton.addEventListener('click', showChatListView);
        peopleBackToListButton.addEventListener('click', showChatListView);
        busesBackToListButton.addEventListener('click', showChatListView);
        settingsBackToListButton.addEventListener('click', hideSettingsView); // Back from settings to chat list

        // Settings button in header
        settingsButton.addEventListener('click', showPasswordModal);

        // Character form buttons
        saveCharacterButton.addEventListener('click', saveCharacter);
        addNewCharacterButton.addEventListener('click', clearCharacterForm);
        cancelEditButton.addEventListener('click', clearCharacterForm);

        // Message input and send buttons
        sendButton.addEventListener('click', () => {
            const characterData = allCharacters[activeChatbotId];
            if (chatInput.value.trim() && activeChatbotId && characterData && !isTyping) { // Added !isTyping check
                sendMessageToGemini(chatInput.value.trim(), characterData.name, characterData.profilePic, characterData.persona);
                suggestedRepliesContainer.classList.add('hidden');
            }
        });

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !isTyping) { // Added !isTyping check
                sendButton.click();
            }
        });

        suggestReplyButton.addEventListener('click', generateSuggestedReplies);
        summarizeChatButton.addEventListener('click', summarizeChat);

        // Mobile sidebar toggle buttons
        openSidebarBtn.addEventListener('click', () => toggleMobileSidebar(true));
        closeSidebarBtn.addEventListener('click', () => toggleMobileSidebar(false));


        // --- Initialize App on Window Load ---
        window.onload = () => {
            lucide.createIcons(); // Initialize Lucide icons
            initFirebaseAndAuth(); // Start Firebase initialization and authentication
        };
    </script>
</body>
</html>